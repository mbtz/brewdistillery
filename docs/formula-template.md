# Formula templates and validation

This document defines the default formula template, template overrides, and
validation rules for rendered Homebrew formulae.

## Default template

The default formula template is generated by the renderer and includes:
- `desc`, `homepage`, `url`, `sha256`, `license`, `version`
- `def install` with either a single `bin.install` line or a multi-bin list

Single-binary output (universal asset):
```
class Brewtool < Formula
  desc "Brew tool"
  homepage "https://example.com"
  url "https://example.com/brewtool-1.2.3.tar.gz"
  sha256 "deadbeef"
  license "MIT"
  version "1.2.3"

  def install
    bin.install "brewtool"
  end
end
```

Multi-binary output (universal asset):
```
class Brewtool < Formula
  desc "Brew tool"
  homepage "https://example.com"
  url "https://example.com/brewtool-1.2.3.tar.gz"
  sha256 "deadbeef"
  license "MIT"
  version "1.2.3"

  def install
    bin.install "brewctl", "brewtool"
  end
end
```

Per-target asset output (macOS + Linux):
```
class Brewtool < Formula
  desc "Brew tool"
  homepage "https://example.com"
  on_macos do
    if Hardware::CPU.arm?
      url "https://example.com/brewtool-1.2.3-darwin-arm64.tar.gz"
      sha256 "armsha"
    else
      url "https://example.com/brewtool-1.2.3-darwin-amd64.tar.gz"
      sha256 "amdsha"
    end
  end
  on_linux do
    if Hardware::CPU.arm?
      url "https://example.com/brewtool-1.2.3-linux-arm64.tar.gz"
      sha256 "linuxarm"
    else
      url "https://example.com/brewtool-1.2.3-linux-amd64.tar.gz"
      sha256 "linuxamd"
    end
  end
  license "MIT"
  version "1.2.3"

  def install
    bin.install "brewtool"
  end
end
```

## Template overrides

### `template.install_block`

When `template.install_block` is set, it replaces the default `bin.install`
lines. The block is inserted with the correct indentation under `def install`.

Example:
```
[template]
install_block = "bin.install \"brewtool\"\nlibexec.install Dir[\"*\"]"
```

### `template.path`

When `template.path` is set, `brewdistillery` reads the file and replaces
placeholders with rendered values. Relative paths are resolved from the current
working directory (the CLI repo root when running `bd`).

Required placeholders:
- `{class}`: formula Ruby class name (CamelCase)
- `{desc}`: escaped description string
- `{homepage}`: escaped homepage string
- `{assets}`: rendered URL/SHA block (already indented)
- `{license}`: escaped SPDX string
- `{version}`: escaped version string
- `{install_block}`: rendered install block (already indented)

Optional placeholders:
- `{name}`: normalized formula name (escaped)

If a required placeholder is missing, rendering fails with:
`template is missing required placeholder <name>` (exit code 3).

Minimal custom template example:
```
class {class} < Formula
  desc "{desc}"
  homepage "{homepage}"
{assets}  license "{license}"
  version "{version}"

  def install
{install_block}  end
end
```

## Validation rules

Rendering fails with exit code 3 for invalid inputs. Key rules:
- Formula name must be non-empty, normalized, and not start with `homebrew-`.
- Description, homepage, license, and version must be non-empty strings.
- `bin` must include at least one non-empty entry.
- `template.install_block` must not be empty when provided.
- Asset matrices must be valid:
  - Universal assets require a URL and SHA.
  - Per-OS matrices must include at least one target.
  - Per-target matrices must include at least one target and no duplicates.

See `docs/asset-selection.md` for OS/arch target configuration and selection
rules.
